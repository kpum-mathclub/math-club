<!DOCTYPE html>
<html lang="ja" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>京都府立医科大学数学研究部 | Math Club</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300..800&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

  <!-- p5.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>

  <style>
    :root{
      --bg:#0b0d12; --fg:#e7e9ee; --muted:#9aa3af;
      --accent:#54d6a3; --accent-2:#5da8ff;
      --glass:rgba(255,255,255,.08); --border:rgba(255,255,255,.18);
      --shadow:0 10px 30px rgba(0,0,0,.35); --card-radius:18px;
      --focus:0 0 0 3px rgba(93,168,255,.35);
    }
    [data-theme="light"]{
      --bg:#f7f8fb; --fg:#0c111a; --muted:#4b5563;
      --accent:#1ea972; --accent-2:#2f7cff;
      --glass:rgba(255,255,255,.7); --border:rgba(17,24,39,.08);
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --focus:0 0 0 3px rgba(47,124,255,.25);
    }

    *{box-sizing:border-box}
    html,body{height:100%;}
    html, body {
      margin:0; padding:0; overflow-x:hidden;
      background:var(--bg); color:var(--fg);
      font-family:"Inter", system-ui, -apple-system, "Noto Serif JP", serif;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
      overscroll-behavior: none;
    }
    a{color:inherit; text-decoration:none}
    a:focus-visible, button:focus-visible{outline:none; box-shadow:var(--focus); border-radius:10px}

    body.dragging, body.dragging *{ user-select:none; cursor:grabbing!important; }

    /* ===== LAYERS ===== */
    .bg-gradient{
      position:fixed; inset:0; z-index:0;
      background:
        radial-gradient(1000px 600px at 15% 20%, rgba(84,214,163,.25), transparent 60%),
        radial-gradient(900px 700px at 85% 70%, rgba(93,168,255,.22), transparent 55%),
        linear-gradient(180deg, var(--bg) 0%, var(--bg) 100%);
    }
    /* p5キャンバス（専用レイヤー） */
    #game-layer{ position:fixed; inset:0; z-index:2; pointer-events:none; }
    #game-layer canvas{ position:absolute; inset:0; }

    /* ===== UI LAYER ===== */
    #ui-layer{ position:relative; z-index:10; }
    nav{
      position:fixed; top:0; left:0; right:0; z-index:11;
      backdrop-filter: blur(12px);
      background: linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.10)), var(--glass);
      border-bottom:1px solid var(--border);
    }
    .nav-inner{ max-width:1100px; margin:0 auto; display:flex; align-items:center; gap:20px; padding:14px 24px; }
    .brand{ display:flex; align-items:center; gap:12px; font-weight:700; font-family:"Noto Serif JP", serif; letter-spacing:.02em; }
    .brand-badge{ display:inline-grid; place-items:center; width:34px; height:34px; border-radius:10px;
      background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#fff; font-weight:800; box-shadow:0 6px 18px rgba(0,0,0,.25); }
    .nav-links{ margin-left:auto; display:flex; gap:18px; flex-wrap:wrap; align-items:center;}
    .nav-links a{ padding:8px 10px; border-radius:10px; opacity:.95; }
    .nav-links a:hover{ background:var(--glass); }
    .theme-toggle{ margin-left:6px; border:1px solid var(--border); background:var(--glass); border-radius:12px; padding:8px 12px; cursor:pointer; box-shadow:var(--shadow); font-weight:600; }

    /* 難易度（Walker数）コントロール） */
    .difficulty{
      display:flex; gap:10px; align-items:center; padding:8px 12px; border-radius:12px;
      background:var(--glass); border:1px solid var(--border); box-shadow:var(--shadow); font-size:13px;
    }
    .difficulty input[type="range"]{ width:160px; accent-color: var(--accent-2); }

    main{ padding-top:86px; }
    .container{ max-width:1100px; margin:0 auto; padding:28px 24px 64px; }
    .hero{
      position:relative; overflow:hidden; border:1px solid var(--border); border-radius:24px;
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); backdrop-filter: blur(10px);
      padding:44px 36px; box-shadow: var(--shadow);
    }
    .hero h1{ margin:0 0 10px; font-size:clamp(26px, 4vw, 40px); font-family:"Noto Serif JP", serif; }
    .hero p{ margin:0 0 24px; color:var(--muted); font-size:clamp(14px, 2vw, 16px); }
    .badge{ display:inline-flex; gap:10px; align-items:center; padding:8px 12px; border-radius:999px; font-weight:600;
      background:linear-gradient(135deg, rgba(84,214,163,.2), rgba(93,168,255,.2)); border:1px solid var(--border); margin-bottom:10px; }
    .cta-grid{ display:grid; gap:16px; grid-template-columns:repeat(3, minmax(0,1fr)); }
    @media (max-width:820px){ .cta-grid{ grid-template-columns:1fr; } }
    .card{ display:block; padding:20px; border-radius:var(--card-radius); border:1px solid var(--border); background:var(--glass);
      box-shadow: var(--shadow); transition: transform .2s ease, border-color .2s ease; }
    .card:hover{ transform: translateY(-2px); border-color: rgba(93,168,255,.45); }

    .control-hint{
      position:fixed; right:18px; bottom:18px; z-index:12;
      display:flex; gap:10px; align-items:center; background:var(--glass); border:1px solid var(--border);
      border-radius:12px; padding:10px 12px; backdrop-filter: blur(8px); box-shadow: var(--shadow); font-size:13px; color:var(--muted);
    }
    .dot{ width:10px; height:10px; border-radius:50%; background: radial-gradient(circle at 40% 35%, rgba(0,255,120,.9), rgba(0,255,120,.3)); box-shadow:0 0 18px rgba(0,255,120,.55); }

    .section{ margin-top:28px; display:grid; gap:16px; grid-template-columns:1fr 1fr; }
    .section .panel{ padding:20px; border-radius:var(--card-radius); border:1px solid var(--border); background:var(--glass); box-shadow: var(--shadow); }
    @media (max-width:920px){ .section{ grid-template-columns:1fr; } }

    footer{ margin-top:36px; padding:18px; text-align:center; color:var(--muted); font-size:13px; }

    /* ===== START OVERLAY（重厚木製の扉） ===== */
    .start-overlay{
      position:fixed; inset:0; z-index:30; display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:28px; backdrop-filter: blur(12px);
      background:
        radial-gradient(40% 35% at 50% 50%, rgba(0,0,0,.25), transparent 60%),
        radial-gradient(60% 50% at 50% 40%, rgba(255,255,255,.08), transparent 70%);
    }
    .door-scene{
      position:relative; width:min(860px, 92vw); height:min(360px, 58vh);
      perspective:1400px; border-radius:16px; border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(0,0,0,.35), rgba(0,0,0,.15));
      box-shadow: var(--shadow); overflow:hidden;
    }
    .door{
      position:absolute; top:0; bottom:0; width:50%; transform-style: preserve-3d;
      background:
        repeating-linear-gradient(90deg, rgba(30,18,10,.35) 0px, rgba(30,18,10,.35) 1px, rgba(30,18,10,.15) 1px, rgba(30,18,10,.15) 3px),
        linear-gradient(180deg, rgba(255,255,255,.03) 0%, rgba(0,0,0,.12) 100%),
        linear-gradient(180deg, #3b2618 0%, #2a1a10 100%);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.06),
        inset 0 0 0 2px rgba(0,0,0,.25),
        inset 0 20px 40px rgba(0,0,0,.35),
        inset 0 -20px 40px rgba(0,0,0,.4),
        0 18px 40px rgba(0,0,0,.45);
      transition: transform 1.25s cubic-bezier(.2,.75,.2,1.0);
      will-change: transform;
      border-right:1px solid rgba(0,0,0,.35);
    }
    .door::after{
      content:""; position:absolute; top:0; bottom:0; width:14px; transform: translateZ(-1px);
      background: linear-gradient(180deg, #2b1d12, #1d130c);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.05);
    }
    .door.left{ left:0; transform-origin:left center; }
    .door.right{ right:0; transform-origin:right center; }
    .door.left::after{ right:-14px; } .door.right::after{ left:-14px; }

    .door::before{
      content:""; position:absolute; inset:14px; border-radius:8px;
      background:
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(0,0,0,.25)),
        repeating-linear-gradient(90deg, rgba(255,255,255,.03) 0, rgba(255,255,255,.03) 2px, rgba(0,0,0,.08) 2px, rgba(0,0,0,.08) 4px),
        linear-gradient(180deg, #3a2417, #2a1a10 60%, #24160e 100%);
      border:1px solid rgba(0,0,0,.5);
      box-shadow:
        inset 0 0 0 1px rgba(255,255,255,.06),
        inset 0 10px 20px rgba(0,0,0,.35),
        inset 0 -10px 25px rgba(0,0,0,.45);
    }
    .handle{
      position:absolute; top:50%; width:22px; height:22px; border-radius:50%; transform: translateY(-50%);
      background: radial-gradient(circle at 35% 35%, #fff, rgba(255,255,255,.5) 45%, rgba(230,210,120,.6) 60%, rgba(120,90,20,.9) 100%);
      box-shadow: 0 6px 14px rgba(0,0,0,.45), inset 0 0 2px rgba(255,255,255,.6);
      border:1px solid rgba(255,255,255,.25);
    }
    .door.left .handle{ right:22px; } .door.right .handle{ left:22px; }
    .handle::after{
      content:""; position:absolute; inset:-10px; border-radius:12px;
      background: linear-gradient(135deg, rgba(255,255,255,.15), rgba(0,0,0,.35));
      border:1px solid rgba(255,255,255,.08); box-shadow: inset 0 0 0 1px rgba(0,0,0,.5); z-index:-1;
    }
    .door-copy{ position:absolute; inset:0; display:grid; place-items:center; pointer-events:none; font-family:"Noto Serif JP", serif; text-align:center; }
    .door-copy h2{ margin:0; font-weight:800; letter-spacing:.04em; font-size:clamp(22px, 3.5vw, 36px); text-shadow:0 10px 30px rgba(0,0,0,.5); }
    .door-copy p{ margin:10px 0 0; color:rgba(255,255,255,.7); font-size:clamp(13px, 1.8vw, 15px); }
    .start-overlay.opening .door.left{  transform: rotateY(-96deg); }
    .start-overlay.opening .door.right{ transform: rotateY( 96deg); }
    .start-overlay.opening .door-copy{ opacity:0; transition: opacity .45s ease .25s; }

    .start-actions{ display:flex; gap:12px; align-items:center; }
    .start-btn{
      font-family:"Inter","Noto Serif JP",serif; font-weight:800; letter-spacing:.08em;
      padding:16px 24px; border-radius:16px; border:1px solid var(--border);
      background:linear-gradient(135deg, var(--accent), var(--accent-2));
      color:#fff; font-size:18px; cursor:pointer; box-shadow:0 14px 40px rgba(0,0,0,.35);
    }
    .start-btn:active{ transform:translateY(1px); }
    .start-skip{
      padding:14px 18px; border-radius:12px; border:1px solid var(--border);
      background:var(--glass); color:var(--fg); font-weight:700; cursor:pointer; box-shadow: var(--shadow);
    }

    /* PLAY AGAIN（ホーム右下） */
    .play-again-btn{
      position:fixed; right:18px; bottom:80px; z-index:12;
      display:none; align-items:center; gap:8px;
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:linear-gradient(135deg, var(--accent), var(--accent-2));
      color:#fff; font-weight:700; cursor:pointer; box-shadow: var(--shadow); letter-spacing:.02em;
    }

    /* GAME OVER OVERLAY */
    .gameover-overlay{
      position:fixed; inset:0; z-index:35; display:none; align-items:center; justify-content:center;
      backdrop-filter: blur(10px); background: rgba(0,0,0,.25);
    }
    .gameover-card{
      background: var(--glass); border:1px solid var(--border); border-radius:16px; padding:20px; box-shadow: var(--shadow);
      min-width:240px; display:flex; flex-direction:column; gap:14px; align-items:center;
    }
    .gameover-title{ font-weight:800; font-size:20px; letter-spacing:.05em; }
    .btn-row{ display:flex; gap:10px; }
    .btn{ padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; }
    .btn.primary{ background:linear-gradient(135deg, var(--accent), var(--accent-2)); color:#fff; border:1px solid var(--border); box-shadow: var(--shadow); }
    .btn.ghost{ background:var(--glass); color:var(--fg); border:1px solid var(--border); }

    /* GAME-ONLY */
    body.game-only #ui-layer { display:none !important; }
    body.game-only { overflow:hidden; }

    /* ===== 蔵書モーダル ===== */
    .modal{ position:fixed; inset:0; z-index:40; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,.35); backdrop-filter: blur(6px); }
    .modal .panel{ width:min(1000px, 94vw); max-height:80vh; overflow:auto; background: var(--glass); border:1px solid var(--border); border-radius:16px; padding:16px; box-shadow: var(--shadow); }
    .modal h3{ margin:4px 0 10px; font-family:"Noto Serif JP",serif; }
    .modal .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .modal input, .modal select{
      background: var(--bg); color:var(--fg); border:1px solid var(--border); border-radius:10px; padding:8px 10px;
    }
    .modal table{ width:100%; border-collapse: collapse; margin-top:10px; font-size:14px; }
    .modal th, .modal td{ border-bottom:1px solid var(--border); padding:8px; text-align:left; }
    .modal .close{ margin-left:auto; padding:8px 10px; border-radius:10px; border:1px solid var(--border); background:var(--glass); cursor:pointer; }
    .muted{ color:var(--muted); font-size:12px; margin:6px 0 0; }
  </style>
</head>
<body>
  <!-- 背景 -->
  <div class="bg-gradient"></div>

  <!-- p5用キャンバスの専用レイヤー -->
  <div id="game-layer" aria-hidden="true"></div>

  <!-- START Overlay（扉＋Skip） -->
  <div id="start-overlay" class="start-overlay">
    <div class="door-scene" aria-hidden="true">
      <div class="door left"><span class="handle"></span></div>
      <div class="door right"><span class="handle"></span></div>
      <div class="door-copy">
        <div>
          <h2>Kyoto Prefectural Univ. of Medicine<br/>Math Club</h2>
          <p>Swipe / Drag to guide the green point from START to GOAL.</p>
        </div>
      </div>
    </div>
    <div class="start-actions" aria-label="Game actions">
      <button id="startBtn" class="start-btn">ENTER &nbsp;/&nbsp; GAME START</button>
      <button id="skipStartBtn" class="start-skip">Skip</button>
    </div>
  </div>

  <!-- GAME OVER Overlay -->
  <div id="gameover-overlay" class="gameover-overlay" aria-modal="true">
    <div class="gameover-card">
      <div class="gameover-title">Game Over</div>
      <div class="btn-row">
        <button id="retryBtn" class="btn primary">Retry</button>
        <button id="skipBtn" class="btn ghost">Skip</button>
      </div>
    </div>
  </div>

  <!-- UIレイヤー -->
  <div id="ui-layer">
    <nav>
      <div class="nav-inner">
        <div class="brand">
          <div class="brand-badge">∑</div>
          <div>京都府立医科大学 数学研究部</div>
        </div>

        <div class="nav-links" role="navigation" aria-label="Main">
          <a href="index.html">Home</a>
          <a href="schedule.html">Schedule</a>
          <a href="contact.html">Contact</a>
          <a href="#" id="openBooks">蔵書</a>
          <a href="qa.html">Q&amp;A</a>

          <!-- 難易度（Walker数） -->
          <div class="difficulty" title="黒点（Walker）の数">
            <span>Difficulty</span>
            <input id="walkerRange" type="range" min="50" max="600" step="10" />
            <span id="walkerValue"></span>
            <button id="applyWalker" class="theme-toggle" style="padding:6px 10px;">Apply</button>
          </div>

          <button class="theme-toggle" onclick="toggleTheme()">Theme</button>
        </div>
      </div>
    </nav>

    <main>
      <div class="container">
        <section class="hero">
          <div class="badge">Official Site</div>
          <h1>京都府立医科大学 数学研究部 公式HP</h1>
          <p>幾何と動きの美しさで数学をもっと身近に。三角タイル上のウォーカーを操作して、<br/>START から GOAL へ。画面をフリック / ドラッグで進行方向を指示できます。</p>
          <div class="cta-grid">
            <a class="card" href="schedule.html"><h3>Schedule</h3><p>例会 / 勉強会 / イベントの予定をチェック。</p></a>
            <a class="card" href="contact.html"><h3>Contact</h3><p>参加希望・見学の希望はこちら。</p></a>
            <a class="card" href="qa.html"><h3>Q&amp;A</h3><p>入部・活動内容・必要スキルetc。</p></a>
          </div>
        </section>

        <section class="section" aria-label="about">
          <div class="panel">
            <h3 style="margin:0 0 8px;font-family:'Noto Serif JP',serif;">活動の目的</h3>
            <p style="margin:0;color:var(--muted);">数学力や基本的なサイエンス力の底上げを図り、医学を多角的に学ぶ。</p>
          </div>
          <div class="panel">
            <h3 style="margin:0 0 8px;font-family:'Noto Serif JP',serif;">Works</h3>
            <p style="margin:0;color:var(--muted);">p5.js / JavaScript / LaTeX / GeoGebra。作品やスライドは定期的に公開予定。</p>
          </div>
        </section>

        <footer>© Kyoto Prefectural University of Medicine Math Club Established in 2024</footer>
      </div>
    </main>

    <div class="control-hint">
      <div class="dot"></div>
      <span>画面をフリック / ドラッグで操作し、Greenの点をGoalに導こう。</span>
    </div>

    <button id="playAgainBtn" class="play-again-btn">Play Again</button>
  </div>

  <!-- 蔵書モーダル -->
  <div id="booksModal" class="modal" aria-modal="true" role="dialog" aria-label="蔵書検索">
    <div class="panel">
      <div class="row" style="justify-content:space-between;">
        <h3>蔵書検索</h3>
        <button class="close" id="closeBooks">閉じる</button>
      </div>

      <!-- 検索行（出版社/タイトル/ISBN） -->
      <div class="row" style="margin-top:6px;">
        <input type="search" id="q" placeholder="キーワード（タイトル/著者/出版社/分類/メモ）" style="flex:1; min-width:220px;">
        <input type="text" id="titleInput" placeholder="タイトル">
        <input type="text" id="publisherInput" placeholder="出版社">
        <input type="text" id="isbnInput" placeholder="ISBN（ハイフン不要）" inputmode="numeric">
        <select id="year">
          <option value="">年（すべて）</option>
        </select>
        <button class="theme-toggle" id="searchBtn" style="padding:8px 12px;">検索</button>
      </div>
      <p id="catalogMsg" class="muted">蔵書データを読み込み中…</p>
      <div id="results"></div>
    </div>
  </div>

  <!-- ===== JavaScript（全部この1つのタグで完結） ===== -->
  <script>
    // ====== グローバル状態 ======
    window.hideCanvasText = false;
    window.__appState = 'home';
    const DEFAULT_WALKERS = parseInt(localStorage.getItem('walkerCount') || '300', 10);

    // ====== 共通UI ======
    function switchToHomeUI(){
      document.body.classList.remove('game-only');
      window.__appState = 'home';
      window.hideCanvasText = false;
      document.getElementById('start-overlay').style.display = 'none';
      document.getElementById('gameover-overlay').style.display = 'none';
      document.getElementById('playAgainBtn').style.display = 'inline-flex';
      window.dispatchEvent(new Event('resize'));
    }
    (function(){
      const saved = localStorage.getItem('theme');
      if(saved) document.documentElement.setAttribute('data-theme', saved);
      window.toggleTheme = function(){
        const root = document.documentElement;
        const next = root.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        root.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
      }
    })();

    function startGame(){
      document.body.classList.add('game-only');
      window.__appState = 'game';
      window.hideCanvasText = true;
      document.getElementById('playAgainBtn').style.display = 'none';
      document.getElementById('gameover-overlay').style.display = 'none';
      if (window.__game && typeof window.__game.loop === 'function') window.__game.loop();
      if (window.__resetGame) window.__resetGame();
      if (window.__ensureGameAlive) window.__ensureGameAlive();
      window.dispatchEvent(new Event('resize'));
    }

    window.__onGameClear = ()=>{ switchToHomeUI(); };

    (function(){ // Start overlay & buttons
      const startBtn = document.getElementById('startBtn');
      const skipStart = document.getElementById('skipStartBtn');
      const overlay = document.getElementById('start-overlay');
      let opening = false;

      startBtn.addEventListener('click', ()=>{
        if (opening) return;
        opening = true;
        overlay.classList.add('opening');
        setTimeout(()=>{
          overlay.style.display = 'none';
          overlay.classList.remove('opening');
          startGame();
          opening = false;
        }, 920);
      });
      skipStart.addEventListener('click', ()=>{ overlay.style.display = 'none'; switchToHomeUI(); });
      window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ overlay.style.display = 'none'; switchToHomeUI(); }});
      document.getElementById('playAgainBtn').addEventListener('click', startGame);
      document.getElementById('retryBtn').addEventListener('click', startGame);
      document.getElementById('skipBtn').addEventListener('click', switchToHomeUI);
    })();

    (function(){ // 難易度UI
      const range = document.getElementById('walkerRange');
      const val = document.getElementById('walkerValue');
      const apply = document.getElementById('applyWalker');
      range.value = DEFAULT_WALKERS;
      val.textContent = DEFAULT_WALKERS;
      range.addEventListener('input', ()=> val.textContent = range.value);
      apply.addEventListener('click', ()=>{
        const n = parseInt(range.value,10);
        localStorage.setItem('walkerCount', String(n));
        if (window.__setWalkerCount) window.__setWalkerCount(n);
      });
    })();

    /* ============================
       Google Sheets 読み込み部
       ============================ */
    const SHEET_ID   = '11h1ILZfrChHJv3NdUVzjKUHq2lgTsLKRWSN1p02TU5E';
    const SHEET_NAME = '蔵書'; // タブ名
    const GVIZ_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(SHEET_NAME)}&t=${Date.now()}`;

    function setCatalogMsg(text, type='info'){
      const el = document.getElementById('catalogMsg');
      if (!el) return;
      el.textContent = text;
      el.style.color = type === 'error' ? '#ff8a8a' : (type === 'warn' ? '#ffd27a' : 'var(--muted)');
    }

    async function fetchSheetRows(){
      const res  = await fetch(GVIZ_URL, { cache: 'no-store' });
      if (!res.ok) throw new Error('HTTP ' + res.status);
      const text = await res.text();
      // gviz JSON をパース
      const json = JSON.parse(text.replace(/^[\s\S]*setResponse\(/, '').replace(/\);?\s*$/, ''));
      const cols = json.table.cols.map(c => c.label || c.id);
      const rows = json.table.rows.map(row => {
        const obj = {};
        cols.forEach((h, i) => obj[h] = row.c[i]?.v ?? '');
        return obj;
      });
      return rows;
    }

    const MAP = {
      title:     ['タイトル','Title','書名','題名'],
      author:    ['著者','Author','作者'],
      publisher: ['出版社','Publisher','出版','発行元'],
      isbn:      ['ISBN','ＩＳＢＮ','Isbn'],
      category:  ['分類','カテゴリ','カテゴリー','ジャンル','Category'],
      year:      ['年','刊行年','Year'],
      memo:      ['メモ','備考','注記','Note'],
      keyword:   ['キーワード','検索語','Keywords']
    };
    function pick(row, keys){ for(const k of keys){ if(k in row && row[k] !== '') return row[k]; } return ''; }

    function mapToCatalog(rows){
      return rows.map(r=>{
        const title     = pick(r, MAP.title);
        const author    = pick(r, MAP.author);
        const publisher = pick(r, MAP.publisher);
        const isbn      = pick(r, MAP.isbn);
        const category  = pick(r, MAP.category);
        const yearRaw   = pick(r, MAP.year);
        const memo      = pick(r, MAP.memo);
        const keyword   = pick(r, MAP.keyword);
        const year      = Number(yearRaw) || null;
        return {
          title, author, publisher, isbn, category, year, memo,
          _q: [title, author, publisher, isbn, category, yearRaw, memo, keyword].filter(Boolean).join(' ')
        };
      });
    }

    async function loadCatalog(){
      try{
        setCatalogMsg('蔵書データを読み込み中…', 'info');
        const rows = await fetchSheetRows();
        const data = mapToCatalog(rows).filter(x => Object.values(x).some(v => v && String(v).trim() !== ''));
        if (!data.length) throw new Error('no rows');
        window.__catalog = data; // グローバルに供給
        setCatalogMsg(`蔵書データを読み込みました（${data.length}件）。`, 'info');
      }catch(e){
        console.error('Sheets read failed:', e);
        setCatalogMsg('Sheetsの読み込みに失敗しました。シートを公開（リンク所持者が閲覧可）にしてください。', 'error');
        window.__catalog = [];
      }
    }
    // 起動時ロード
    document.addEventListener('DOMContentLoaded', loadCatalog);

    /* ============================
       検索（モーダル）ロジック
       ============================ */
    (function(){
      const open = document.getElementById('openBooks');
      const close = document.getElementById('closeBooks');
      const modal = document.getElementById('booksModal');
      const q = document.getElementById('q');
      const titleInput = document.getElementById('titleInput');
      const publisherInput = document.getElementById('publisherInput');
      const isbnInput = document.getElementById('isbnInput');
      const yearSel = document.getElementById('year');
      const btn = document.getElementById('searchBtn');
      const results = document.getElementById('results');

      // --- 正規化（全角→半角、空白除去、小文字化） ---
      const Z2H = (s)=> s.replace(/[！-～]/g, ch => String.fromCharCode(ch.charCodeAt(0) - 0xFEE0));
      function normalizeBase(s){ return Z2H(String(s||'')).toLowerCase().replace(/\s+/g,''); }
      function normalizePublisher(s){
        return normalizeBase(s).replace(/（株）|㈱|株式会社|（有）|㈲|有限会社|出版局|出版/g,''); // ゆるめ
      }
      function normalizeISBN(s){ return String(s||'').replace(/[^\dxX]/g,'').toLowerCase(); }

      // --- レンダリング ---
      function render(list){
        if(!list.length){
          results.innerHTML = '<p class="muted">該当なし</p>'; return;
        }
        const rows = list.map(b=>`
          <tr>
            <td>${escapeHtml(b.title||'')}</td>
            <td>${escapeHtml(b.author||'')}</td>
            <td>${escapeHtml(b.publisher||'')}</td>
            <td>${escapeHtml(b.year||'')}</td>
            <td>${escapeHtml(b.isbn||'')}</td>
            <td>${escapeHtml(b.category||'')}</td>
            <td>${escapeHtml(b.memo||'')}</td>
          </tr>`).join('');
        results.innerHTML = `
          <table>
            <thead><tr>
              <th>タイトル</th><th>著者</th><th>出版社</th><th>年</th><th>ISBN</th><th>分類</th><th>メモ</th>
            </tr></thead>
            <tbody>${rows}</tbody>
          </table>`;
      }
      function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

      // --- 検索 ---
      function doSearch(){
        const all = window.__catalog || [];
        const kw = normalizeBase(q.value);
        const tkw = normalizeBase(titleInput.value);
        const pkw = normalizePublisher(publisherInput.value);
        const iskw = normalizeISBN(isbnInput.value);
        const yr = yearSel.value.trim();

        const out = all.filter(b=>{
          const t = normalizeBase(b.title);
          const a = normalizeBase(b.author);
          const p = normalizePublisher(b.publisher);
          const n = normalizeBase(b.memo);
          const c = normalizeBase(b.category);
          const y = (b.year == null ? '' : String(b.year));
          const is = normalizeISBN(b.isbn);

          // フリーワード（タイトル/著者/出版社/分類/メモ）部分一致
          if (kw && !(t.includes(kw) || a.includes(kw) || p.includes(kw) || c.includes(kw) || n.includes(kw))) return false;
          // 個別欄（AND）
          if (tkw && !t.includes(tkw)) return false;
          if (pkw && !p.includes(pkw)) return false;
          if (iskw && !is.includes(iskw)) return false;
          if (yr && y !== yr) return false;
          return true;
        });
        render(out);
      }

      // --- 年プルダウンの構築 ---
      function buildYears(){
        const all = window.__catalog || [];
        const years = Array.from(new Set(all.map(b=> String(b.year||'').trim()).filter(Boolean))).sort();
        yearSel.innerHTML = '<option value="">年（すべて）</option>' + years.map(y=>`<option value="${y}">${y}</option>`).join('');
      }

      async function ensureLoadedAndRender(){
        if (!Array.isArray(window.__catalog)) {
          await loadCatalog();
        }
        buildYears();
        if (Array.isArray(window.__catalog) && window.__catalog.length){
          render(window.__catalog.slice(0,50));
        }else{
          results.innerHTML = '<p class="muted">蔵書データが読み込めませんでした。</p>';
        }
      }

      // --- イベント ---
      open.addEventListener('click', (e)=>{ e.preventDefault(); modal.style.display='flex'; ensureLoadedAndRender(); });
      close.addEventListener('click', ()=> modal.style.display='none');
      btn.addEventListener('click', doSearch);
      q.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
      titleInput.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
      publisherInput.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
      isbnInput.addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
    })();

    /* ============================
       p5.js スケッチ
       ============================ */
    (function(){
      const sketch = (p)=>{
        const sideLength=60;
        let walkerCount = DEFAULT_WALKERS;
        let triangles=[], points=[], adjacency=new Map(), walkers=[];
        let startPoint=null, goalPoint=null, manualWalker=null;
        let gameOver=false, gameClear=false, clearHandled=false;
        let trails=[]; let waveAnim=null;

        const SAFE_RADIUS = 20;
        const isDark = () => document.documentElement.getAttribute('data-theme') !== 'light';
        new MutationObserver(()=>{}).observe(document.documentElement, { attributes:true, attributeFilter:['data-theme'] });

        class Trail{ constructor(x,y){ this.x=x; this.y=y; this.life=255; }
          update(){ this.life-=4; } isAlive(){ return this.life>0; }
          display(){ p.noStroke(); p.fill(0,255,100,this.life*0.4); p.ellipse(this.x,this.y,8); } }
        class Wave{ constructor(x,y){ this.x=x; this.y=y; this.radius=0; this.life=255; }
          update(){ this.radius+=12; this.life-=4; } isAlive(){ return this.life>0; }
          display(){ p.noFill(); p.stroke(0,180,255,this.life); p.strokeWeight(2); p.ellipse(this.x,this.y,this.radius*2); } }

        class ManualWalker{
          constructor(v){ this.current=v; this.next=null; this.t=0; }
          isMoving(){ return !!this.next; }
          stepByAim(a){
            if(this.isMoving()||gameOver||gameClear)return;
            const rad=a*Math.PI/180, aim={x:Math.cos(rad), y:-Math.sin(rad)};
            const key=this.current.x+","+this.current.y;
            const nbrs=adjacency.get(key)?.neighbors||[];
            let best=null,bestDot=0.1;
            for(const n of nbrs){
              const vx=n.x-this.current.x,vy=n.y-this.current.y,len=Math.hypot(vx,vy)||1;
              const dot=(vx/len)*aim.x+(vy/len)*aim.y;
              if(dot>bestDot){ bestDot=dot; best=n; }
            }
            if(best){ this.next=best; this.t=0; }
          }
          update(){
            if(this.next){
              this.t+=0.08;
              if(this.t>=1){
                this.current=this.next; this.next=null; this.t=0;
                trails.push(new Trail(this.current.x,this.current.y));
                if(goalPoint && this.current.x===goalPoint.x && this.current.y===goalPoint.y){
                  gameClear=true; waveAnim=new Wave(goalPoint.x,goalPoint.y);
                }
              }
            }
          }
          getPosition(){
            if(this.next) return p.createVector(p.lerp(this.current.x,this.next.x,this.t), p.lerp(this.current.y,this.next.y,this.t));
            return this.current.copy();
          }
          display(){
            const pos=this.getPosition();
            p.noStroke(); p.fill(100,255,180,80); p.ellipse(pos.x,pos.y,14);
            p.fill(80,255,160); p.ellipse(pos.x,pos.y,6);
          }
        }

        class Walker{
          constructor(){
            let pt; do{ pt=p.random(points);}while(insideAnySafety(pt));
            this.current=pt; this.next=this.chooseNext(pt); this.t=0;
            this.baseSpeed=p.random(0.003,0.008); this.phase=p.random(p.TWO_PI);
          }
          chooseNext(cur){
            const key=cur.x+","+cur.y;
            let opt=adjacency.get(key)?.neighbors||[];
            opt=opt.filter(n=>!insideAnySafety(n));
            if(!opt.length)return cur;
            let next; do{ next=p.random(opt);}while(next.x===cur.x&&next.y===cur.y&&opt.length>1);
            return next;
          }
          update(){ this.t+=this.baseSpeed; if(this.t>=1){ this.current=this.next; this.next=this.chooseNext(this.current); this.t=0; } }
          getPosition(){ return{x:p.lerp(this.current.x,this.next.x,this.t),y:p.lerp(this.current.y,this.next.y,this.t)}; }
          display(){
            const pos=this.getPosition();
            const size=5 + p.sin(p.frameCount*0.05+this.phase)*1.5;
            const glow=16 + 8*p.sin(p.frameCount*0.08+this.phase);
            p.noStroke();
            p.fill(255,255,255, isDark()?42:28); p.ellipse(pos.x, pos.y, size + glow);
            p.fill(255); p.ellipse(pos.x, pos.y, size);
          }
        }

        function generateTriangleGrid(){
          const h=sideLength*Math.sqrt(3)/2; triangles=[]; adjacency.clear();
          for(let y=0;y<p.height+h;y+=h){
            for(let x=0;x<p.width+sideLength;x+=sideLength){
              const xOffset=(Math.floor(y/h)%2)*(sideLength/2);
              const p1=p.createVector(x+xOffset,y),
                    p2=p.createVector(x+sideLength/2+xOffset,y+h),
                    p3=p.createVector(x-sideLength/2+xOffset,y+h);
              triangles.push([p1,p2,p3]); registerEdge(p1,p2); registerEdge(p2,p3); registerEdge(p3,p1);
            }
          }
          points=Array.from(adjacency.values()).map(o=>o.vec);
        }
        function registerEdge(a,b){
          const ka=a.x+","+a.y,kb=b.x+","+b.y;
          if(!adjacency.has(ka))adjacency.set(ka,{vec:a,neighbors:[]});
          if(!adjacency.has(kb))adjacency.set(kb,{vec:b,neighbors:[]});
          const A=adjacency.get(ka).neighbors,B=adjacency.get(kb).neighbors;
          if(!A.some(n=>n.x===b.x&&n.y===b.y))A.push(adjacency.get(kb).vec);
          if(!B.some(n=>n.x===a.x&&n.y===a.y))B.push(adjacency.get(ka).vec);
        }
        function nearestVertex(x,y){ let best=null,bestD=1e9; for(const pt of points){ const d=p.dist(x,y,pt.x,pt.y); if(d<bestD){bestD=d;best=pt;} } return best; }
        function pickStartGoalFixed(){
          startPoint=nearestVertex(60, Math.min(250,p.height-50));
          goalPoint =nearestVertex(Math.max(60,p.width-300), Math.max(60,p.height-300));
        }
        function insideAnySafety(pt){
          return (p.dist(pt.x,pt.y,startPoint.x,startPoint.y)<=SAFE_RADIUS) ||
                 (p.dist(pt.x,pt.y,goalPoint.x,goalPoint.y)<=SAFE_RADIUS);
        }
        function drawStartGoal(){
          p.stroke(0,220,120,220); p.noFill(); p.ellipse(startPoint.x,startPoint.y,18);
          if(!window.hideCanvasText){ p.noStroke(); p.fill(140,255,200); p.text("START",startPoint.x+12,startPoint.y-10); }
          const pulse=22+6*Math.sin(p.frameCount*0.07);
          p.noFill(); p.stroke(100,170,255,230); p.ellipse(goalPoint.x,goalPoint.y,pulse);
          if(!window.hideCanvasText){ p.noStroke(); p.fill(150,200,255); p.text("GOAL",goalPoint.x+12,goalPoint.y-10); }
        }
        function checkCollision(){
          const mp=manualWalker.getPosition();
          for(const w of walkers){ const pos=w.getPosition(); if(p.dist(mp.x,mp.y,pos.x,pos.y)<12) return true; }
          return false;
        }
        function rebuildAll(){
          generateTriangleGrid(); pickStartGoalFixed();
          walkers.length=0;
          for(let i=0;i<walkerCount;i++) walkers.push(new Walker());
          manualWalker=new ManualWalker(startPoint);
          gameOver=false; gameClear=false; clearHandled=false;
          trails=[]; waveAnim=null;
        }

        window.__setWalkerCount = (n)=>{
          walkerCount = Math.max(10, Math.min(2000, n|0));
          localStorage.setItem('walkerCount', String(walkerCount));
          rebuildAll();
        };
        window.__resetGame = ()=>{ rebuildAll(); window.__appState='game'; };
        window.__ensureGameAlive = ()=>{
          if (!triangles.length || !points.length || !walkers.length || !startPoint || !goalPoint){ rebuildAll(); }
        };
        window.__switchToHomeAmbient = ()=>{
          gameOver=false; gameClear=false; clearHandled=false; trails=[]; waveAnim=null; window.__appState='home';
        };

        p.setup=()=>{
          const cnv=p.createCanvas(window.innerWidth, window.innerHeight);
          cnv.parent('game-layer'); cnv.style('pointer-events','none');
          rebuildAll(); setupFlickControls();
        };
        p.windowResized=()=>{ p.resizeCanvas(window.innerWidth, window.innerHeight); rebuildAll(); };

        p.draw=()=>{
          const isHome = (window.__appState === 'home');
          p.clear();

          // タイル
          p.noFill(); p.strokeWeight(1);
          if (document.documentElement.getAttribute('data-theme')==='light'){ p.stroke(0,40); }
          else { p.stroke(255,28); }
          for(const t of triangles){ p.beginShape(); for(const pt of t) p.vertex(pt.x, pt.y); p.endShape(p.CLOSE); }

          // 背景ウォーカー
          for(const w of walkers){ w.update(); w.display(); }

          if (!isHome){
            drawStartGoal();
            for(const t of trails) t.update(); trails=trails.filter(t=>t.isAlive()); for(const t of trails) t.display();
            if (manualWalker){ manualWalker.update(); manualWalker.display(); }
            if(!gameOver && !gameClear && checkCollision()){
              gameOver = true; document.getElementById('gameover-overlay').style.display = 'flex';
            }
            if(gameClear){
              if(!waveAnim) waveAnim = new Wave(goalPoint.x,goalPoint.y);
              waveAnim.update(); waveAnim.display();
              if(!waveAnim.isAlive()){ window.__switchToHomeAmbient(); if (typeof window.__onGameClear === 'function') window.__onGameClear(); }
            }
          }
        };

        function setupFlickControls(){
          let startX=0,startY=0,endX=0,endY=0; let dragging=false, mouseDown=false;
          const threshold=40, blockThreshold=12;
          const getAngle=(dx,dy)=>{let ang=Math.atan2(-dy,dx)*180/Math.PI;if(ang<0)ang+=360;return ang;};

          window.addEventListener("touchstart",e=>{ const t=e.touches[0]; startX=t.clientX; startY=t.clientY; dragging=false; },{passive:true});
          window.addEventListener("touchmove",e=>{
            if(window.__appState!=='game') return;
            const t=e.touches[0]; const dx=t.clientX-startX, dy=t.clientY-startY;
            if(!dragging && Math.hypot(dx,dy)>=blockThreshold){ dragging=true; document.body.classList.add('dragging'); }
            if(dragging){ e.preventDefault(); }
          },{passive:false});
          window.addEventListener("touchend",e=>{
            if(window.__appState!=='game') return;
            const t=e.changedTouches[0]; endX=t.clientX; endY=t.clientY;
            const dx=endX-startX, dy=endY-startY;
            if(Math.hypot(dx,dy)>=threshold){
              const ang=getAngle(dx,dy); const snapped=Math.round(ang/60)*60%360; manualWalker.stepByAim(snapped);
            }
            dragging=false; document.body.classList.remove('dragging');
          });

          window.addEventListener("mousedown",e=>{
            if(window.__appState!=='game') return;
            mouseDown=true; startX=e.clientX; startY=e.clientY; dragging=false;
          });
          window.addEventListener("mousemove",e=>{
            if(window.__appState!=='game') return;
            if(!mouseDown) return;
            const dx=e.clientX-startX, dy=e.clientY-startY;
            if(!dragging && Math.hypot(dx,dy)>=blockThreshold){ dragging=true; document.body.classList.add('dragging'); }
            if(dragging){ e.preventDefault(); }
          });
          window.addEventListener("mouseup",e=>{
            if(window.__appState!=='game') return;
            if(!mouseDown) return; mouseDown=false;
            endX=e.clientX; endY=e.clientY;
            const dx=endX-startX, dy=endY-startY;
            if(Math.hypot(dx,dy)>=threshold){
              const ang=getAngle(dx,dy); const snapped=Math.round(ang/60)*60%360; manualWalker.stepByAim(snapped);
            }
            dragging=false; document.body.classList.remove('dragging');
          });
          window.addEventListener("mouseleave",()=>{ mouseDown=false; dragging=false; document.body.classList.remove('dragging'); });
        }
      };
      window.__game = new p5(sketch);
    })();
  </script>
</body>
</html>
